<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>// services & runtime //</title>
     
    <script>
      // Apply sidebar state immediately to prevent flash
      (function () {
        if (localStorage.getItem("sidebar-collapsed") === "true") {
          document.documentElement.classList.add("sidebar-collapsed");
        }
      })();
    </script>
    <link rel="stylesheet" href="assets/style.css" />
    <script defer src="assets/main.js"></script>
    
    <script>
      window.searchNamespace = window.searchNamespace || {};
      window.searchNamespace.rootPath = "";
    </script>
    <script defer src="assets/search.js"></script>
    
  </head>
  <body>
    <div class="container">
      <header>
        <div class="header-left">
          <h1 class="site-title">
            <a href="index.html"> Documentation</a>
          </h1>

          <nav class="header-nav">
  <ul>
    <li >
      <a href="options.html">Options</a>
    </li>
    
    <li><a href="search.html">Search</a></li>
    
  </ul>
</nav>

        </div>
        
        <div class="search-container">
          <input type="text" id="search-input" placeholder="Search..." />
          <div id="search-results" class="search-results"></div>
        </div>
        
      </header>

      <div class="layout">
        <div class="sidebar-toggle" aria-label="Toggle sidebar">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            width="24"
            height="24"
          >
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
          </svg>
        </div>
        <nav class="sidebar">
          <details class="sidebar-section" data-section="docs" open>
            <summary>Documents</summary>
            <div class="sidebar-section-content">
              <ul>
                <li><a href="index.html">// index //</a></li>
<li><a href="getting-started.html">// `ComfyUI` setup guide //</a></li>
<li><a href="architecture.html">// architecture overview //</a></li>
<li><a href="custom-service.html">// defining a custom service //</a></li>
<li><a href="integrations.html">// integrations //</a></li>
<li><a href="services.html">// services & runtime //</a></li>
<li><a href="search.html">Search</a></li>

              </ul>
            </div>
          </details>

          <details class="sidebar-section" data-section="toc" open>
            <summary>Contents</summary>
            <div class="sidebar-section-content">
              <ul class="toc-list">
                <li><a href="#services---runtime">// services &amp; runtime //</a>
<ul><li><a href="#overview">// overview //</a>
<li><a href="#defining-services">// defining services //</a>
<ul><li><a href="#using-existing-modular-services">using existing modular services</a>
<li><a href="#a-minimal-custom-service">a minimal custom service</a>
</ul><li><a href="#runtime-behavior">// runtime behavior //</a>
<li><a href="#restart-policies">// restart policies //</a>
<li><a href="#logging">// logging //</a>
<li><a href="#config-data">// config data //</a>
</li></ul></li>
              </ul>
            </div>
          </details>
        </nav>

        <main class="content"><html><head></head><body><h1 id="services--amp--runtime">// services &amp; runtime //</h1>
<p>managing long-running processes inside <code>nix2gpu</code> containers.</p>
<hr>
<h2 id="overview">// overview //</h2>
<p><code>nix2gpu</code> uses <a href="https://github.com/weyl-ai/nimi"><code>Nimi</code></a>, a tiny process manager
for <a href="https://nixos.org/manual/nixos/unstable/#modular-services">NixOS modular services</a>
(Nix 25.11). Define services under <code>services.&lt;name&gt;</code> and <code>nix2gpu</code> will build an
OCI image with Nimi as the entrypoint.</p>
<p>No extra flake inputs are required to enable services.</p>
<hr>
<h2 id="defining-services">// defining services //</h2>
<h3 id="using-existing-modular-services"><strong>using existing modular services</strong></h3>
<pre class="highlight"><code class="language-nix"><span style="color:rgb(171,178,191);">services</span><span style="color:rgb(132,139,152);">.</span><span style="color:rgb(152,195,121);">"</span><span style="color:rgb(152,195,121);">ghostunnel</span><span style="color:rgb(152,195,121);">"</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(132,139,152);">{</span><br>&nbsp;&nbsp;<span style="color:rgb(86,182,194);">imports</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(132,139,152);">[</span>&nbsp;<span style="color:rgb(171,178,191);">pkgs</span><span style="color:rgb(132,139,152);">.</span><span style="color:rgb(86,182,194);">ghostunnel</span><span style="color:rgb(132,139,152);">.</span><span style="color:rgb(86,182,194);">services</span>&nbsp;<span style="color:rgb(132,139,152);">]</span><span style="color:rgb(132,139,152);">;</span><br>&nbsp;&nbsp;<span style="color:rgb(86,182,194);">ghostunnel</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(132,139,152);">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:rgb(86,182,194);">listen</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(152,195,121);">"</span><span style="color:rgb(152,195,121);">0.0.0.0:443</span><span style="color:rgb(152,195,121);">"</span><span style="color:rgb(132,139,152);">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:rgb(86,182,194);">cert</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(152,195,121);">"</span><span style="color:rgb(152,195,121);">/root/service-cert.pem</span><span style="color:rgb(152,195,121);">"</span><span style="color:rgb(132,139,152);">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:rgb(86,182,194);">key</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(152,195,121);">"</span><span style="color:rgb(152,195,121);">/root/service-key.pem</span><span style="color:rgb(152,195,121);">"</span><span style="color:rgb(132,139,152);">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:rgb(86,182,194);">disableAuthentication</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(209,154,102);">true</span><span style="color:rgb(132,139,152);">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:rgb(86,182,194);">target</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(152,195,121);">"</span><span style="color:rgb(152,195,121);">backend:80</span><span style="color:rgb(152,195,121);">"</span><span style="color:rgb(132,139,152);">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:rgb(86,182,194);">unsafeTarget</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(209,154,102);">true</span><span style="color:rgb(132,139,152);">;</span><br>&nbsp;&nbsp;<span style="color:rgb(132,139,152);">}</span><span style="color:rgb(132,139,152);">;</span><br><span style="color:rgb(132,139,152);">}</span><span style="color:rgb(132,139,152);">;</span><br></code></pre>
<h3 id="a-minimal-custom-service"><strong>a minimal custom service</strong></h3>
<pre class="highlight"><code class="language-nix"><span style="color:rgb(171,178,191);">services</span><span style="color:rgb(132,139,152);">.</span><span style="color:rgb(152,195,121);">"</span><span style="color:rgb(152,195,121);">hello</span><span style="color:rgb(152,195,121);">"</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(132,139,152);">{</span><br>&nbsp;&nbsp;<span style="color:rgb(86,182,194);">process</span><span style="color:rgb(132,139,152);">.</span><span style="color:rgb(86,182,194);">argv</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(132,139,152);">[</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:rgb(132,139,152);">(</span><span style="color:rgb(171,178,191);">lib</span><span style="color:rgb(132,139,152);">.</span><span style="color:rgb(97,175,239);">getExe</span>&nbsp;<span style="color:rgb(171,178,191);">pkgs</span><span style="color:rgb(132,139,152);">.</span><span style="color:rgb(86,182,194);">bash</span><span style="color:rgb(132,139,152);">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:rgb(152,195,121);">"</span><span style="color:rgb(152,195,121);">-lc</span><span style="color:rgb(152,195,121);">"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:rgb(152,195,121);">"</span><span style="color:rgb(152,195,121);">echo&nbsp;hello&nbsp;from&nbsp;Nimi</span><span style="color:rgb(152,195,121);">"</span><br>&nbsp;&nbsp;<span style="color:rgb(132,139,152);">]</span><span style="color:rgb(132,139,152);">;</span><br><span style="color:rgb(132,139,152);">}</span><span style="color:rgb(132,139,152);">;</span><br></code></pre>
<p>For a full custom module example, see <a href="custom-service.md">defining custom services</a>.</p>
<hr>
<h2 id="runtime-behavior">// runtime behavior //</h2>
<p>When the container starts, Nimi runs the <code>nix2gpu</code> startup hook and then launches
all configured services. You can still drop into a shell for debugging with:</p>
<pre class="highlight"><code class="language-bash"><span style="color:rgb(232,102,113);">$</span>&nbsp;<span style="color:rgb(171,178,191);">docker</span>&nbsp;<span style="color:rgb(232,102,113);">run</span>&nbsp;<span style="color:rgb(232,102,113);">-it</span>&nbsp;<span style="color:rgb(232,102,113);">--entrypoint</span>&nbsp;<span style="color:rgb(232,102,113);">bash</span>&nbsp;<span style="color:rgb(232,102,113);">my-container:latest</span><br></code></pre>
<hr>
<h2 id="restart-policies">// restart policies //</h2>
<p><code>Nimi</code> controls service restarts. Tune it with <code>nimiSettings.restart</code>:</p>
<pre class="highlight"><code class="language-nix"><span style="color:rgb(171,178,191);">nimiSettings</span><span style="color:rgb(132,139,152);">.</span><span style="color:rgb(97,175,239);">restart</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(132,139,152);">{</span><br>&nbsp;&nbsp;<span style="color:rgb(86,182,194);">mode</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(152,195,121);">"</span><span style="color:rgb(152,195,121);">up-to-count</span><span style="color:rgb(152,195,121);">"</span><span style="color:rgb(132,139,152);">;</span>&nbsp;<span style="color:rgb(92,99,112);font-style: italic;">#&nbsp;never&nbsp;|&nbsp;up-to-count&nbsp;|&nbsp;always</span><br>&nbsp;&nbsp;<span style="color:rgb(86,182,194);">time</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(209,154,102);">2000</span><span style="color:rgb(132,139,152);">;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:rgb(92,99,112);font-style: italic;">#&nbsp;delay&nbsp;in&nbsp;ms</span><br>&nbsp;&nbsp;<span style="color:rgb(86,182,194);">count</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(209,154,102);">3</span><span style="color:rgb(132,139,152);">;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:rgb(92,99,112);font-style: italic;">#&nbsp;max&nbsp;restarts&nbsp;when&nbsp;using&nbsp;up-to-count</span><br><span style="color:rgb(132,139,152);">}</span><span style="color:rgb(132,139,152);">;</span><br></code></pre>
<hr>
<h2 id="logging">// logging //</h2>
<p>Logs always stream to stdout/stderr for <code>docker logs</code>. You can also enable
per-service log files:</p>
<pre class="highlight"><code class="language-nix"><span style="color:rgb(171,178,191);">nimiSettings</span><span style="color:rgb(132,139,152);">.</span><span style="color:rgb(97,175,239);">logging</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(132,139,152);">{</span><br>&nbsp;&nbsp;<span style="color:rgb(86,182,194);">enable</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(209,154,102);">true</span><span style="color:rgb(132,139,152);">;</span><br>&nbsp;&nbsp;<span style="color:rgb(86,182,194);">logsDir</span>&nbsp;<span style="color:rgb(171,178,191);">=</span>&nbsp;<span style="color:rgb(152,195,121);">"</span><span style="color:rgb(152,195,121);">nimi_logs</span><span style="color:rgb(152,195,121);">"</span><span style="color:rgb(132,139,152);">;</span><br><span style="color:rgb(132,139,152);">}</span><span style="color:rgb(132,139,152);">;</span><br></code></pre>
<p>At runtime, Nimi creates a <code>logs-&lt;n&gt;</code> directory under <code>logsDir</code> and writes one
file per service.</p>
<hr>
<h2 id="config-data">// config data //</h2>
<p>Modular services can provide config files via <code>configData</code>. Nimi exposes these
files under a temporary directory and sets <code>XDG_CONFIG_HOME</code> for the service.
This lets services read configs from <code>$XDG_CONFIG_HOME/&lt;path&gt;</code> without writing to
the Nix store.</p>
<p>See <code>nix2gpu</code> service modules like <code>services/comfyui.nix</code> for real-world usage.</p>
</body></html></main>
      </div>

      <aside class="page-toc">
        <nav class="page-toc-nav">
          <h3>On this page</h3>
          <ul class="page-toc-list">
            <li><a href="#services---runtime">// services &amp; runtime //</a>
<ul><li><a href="#overview">// overview //</a>
<li><a href="#defining-services">// defining services //</a>
<ul><li><a href="#using-existing-modular-services">using existing modular services</a>
<li><a href="#a-minimal-custom-service">a minimal custom service</a>
</ul><li><a href="#runtime-behavior">// runtime behavior //</a>
<li><a href="#restart-policies">// restart policies //</a>
<li><a href="#logging">// logging //</a>
<li><a href="#config-data">// config data //</a>
</li></ul></li>
          </ul>
        </nav>
      </aside>

      <footer>
  <p>Generated with ndg</p>
</footer>

    </div>

    
  </body>
</html>
